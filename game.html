<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPS-style Controls with Gravity</title>
    <style>
        body { margin: 0; overflow: hidden; }
    </style>
    <script src="https://threejs.org/build/three.js"></script>
</head>
<body>
    <script>
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const cubes = [];
        const cubeSize = 2;
        const groundSize = 20;

        // Create ground
        for (let i = -groundSize / 2; i < groundSize / 2; i += cubeSize) {
            for (let j = -groundSize / 2; j < groundSize / 2; j += cubeSize) {
                const geometry = new THREE.BoxGeometry(cubeSize, cubeSize, cubeSize);
                const material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
                const cube = new THREE.Mesh(geometry, material);
                cube.position.x = i;
                cube.position.y = -2; // Slightly below the origin to serve as the ground
                cube.position.z = j;
                cubes.push(cube);
                scene.add(cube);
            }
        }

        const player = {
            position: new THREE.Vector3(0, 5, 0),
            rotation: new THREE.Euler(0, 0, 0),
            velocity: new THREE.Vector3(0, 0, 0),
            isGrounded: false,
        };

        const moveSpeed = 0.1;
        const rotateSpeed = 0.02;
        const gravity = 0.005;

        const gamepadState = {
            axes: [0, 0],
            buttons: [],
        };

        window.addEventListener("gamepadconnected", (event) => {
            console.log("Gamepad connected:", event.gamepad);
            checkGamepadInput(event.gamepad.index);
        });

        window.addEventListener("gamepaddisconnected", (event) => {
            console.log("Gamepad disconnected:", event.gamepad);
        });

        function checkGamepadInput(gamepadIndex) {
            requestAnimationFrame(() => {
                const gamepad = navigator.getGamepads()[gamepadIndex];

                if (gamepad) {
                    // Adjust player rotation based on right stick input
                    player.rotation.y -= gamepad.axes[2] * rotateSpeed;
                    player.rotation.x += gamepad.axes[3] * rotateSpeed;

                    // Calculate movement direction based on player rotation
                    const moveDirection = new THREE.Vector3(
                        -Math.sin(player.rotation.y),
                        0,
                        -Math.cos(player.rotation.y)
                    );

                    // Apply gravity
                    if (!player.isGrounded) {
                        player.velocity.y -= gravity;
                    }

                    // Update player position based on left stick input
                    player.position.addScaledVector(moveDirection, gamepad.axes[1] * moveSpeed);

                    // Check for collisions with ground
                    player.isGrounded = false;
                    for (const cube of cubes) {
                        if (player.position.distanceTo(cube.position) < cubeSize / 2) {
                            player.isGrounded = true;
                            player.velocity.y = 0; // Stop falling when grounded
                            player.position.y = cube.position.y + cubeSize / 2;
                            break;
                        }
                    }

                    // Update camera position and rotation based on player
                    camera.position.copy(player.position);
                    camera.rotation.copy(player.rotation);

                    // Repeat the check
                    checkGamepadInput(gamepadIndex);
                }

                renderer.render(scene, camera);
            });
        }
    </script>
</body>
</html>
